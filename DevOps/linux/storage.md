# 存储

![20200910160052](https://raw.githubusercontent.com/protoleoxu/picGo/master/images/20200910160052.png)  

linux 文件系统层次。

## **磁盘**

### **物理结构**

磁盘物理结构一般由磁头、盘片、电动机、主控芯片与排线等部件组成。  
盘片表面有磁性涂料，磁头读取盘片存储的数据。  
盘片由电机带动做圆周运动，磁头由机械臂和点击沿盘片半径做直线运动。  
每个磁盘有多个盘片，每个盘片正反两面都可以使用，从上到下从0开始编号；磁头数量等于盘片数量 x 2。  
磁盘工作时，最多只有一个磁头进行读写。  
寻道：磁头机械臂移动到正确读写位置。  
旋转：盘片旋转到正确位置。  

### **逻辑结构**

**磁道（track）**：盘片同心圆划分的圆圈，一个盘片有许多磁道，由最外圈从0开始向内编号。  
**扇区（sector）**：磁道被划分的圆弧，是磁盘读写的最小单位。  
**柱面（cylinder）**：多个盘片相同磁道纵向组成的空心圆柱。  

寻道时间：将磁头移动到正确磁道花费的时间。  
旋转延迟：将数据所在扇区旋转至磁头下需要的时间。  
数据传输时间：传输数据所需时间。  

### **寻址**

#### **CHS（Cylinder-Header-Sector）**

早期寻址方式。  
读写时提供柱面号（8bit）、磁头号（10bit）、扇区号（6bit）。  

#### **LBA（Logical Block Addressing）**

LBA编址方式不再划分柱面和磁头号，这些数据由磁盘自身保留，而磁盘对外提供的地址全部为线性的地址，即LBA地址。  

### **通信接口**

### **驱动**

### **分区**

#### **MBR（Master Boot Record）**

主引导记录，计算机启动访问的第一个扇区，CHS地址（柱面，磁头，扇区）=（0，0，1）。  

##### **结构**

![20200909155958](https://raw.githubusercontent.com/protoleoxu/picGo/master/images/20200909155958.png)

**主引导分区（MBR）**：第一阶段引导代码，其中的硬盘引导程序的主要作用是**检查分区表是否正确**并且在系统硬件完成自检以后将控制权交给硬盘上的引导程序（如GNU GRUB）。它不依赖任何操作系统，而且启动代码也是可以改变的，从而能够实现多系统引导。  
**硬盘分区表**：可以对四个分区的信息进行描述，其中每个分区的信息占据16个字节。  
**结束标志字**：55，AA（偏移1FEH－偏移1FFH）最后两个字节，是检验主引导记录是否有效的标志。  

##### **限制**

MBR分区表只能存储4个分区表信息，最多能识别4个主要分区（Primary partition）。  
需要建立更多的分区，需要使用扩展分区，扩展分区也是主要分区，且只能有一个。  
扩展分区表中第一个分区表存储当前分区起始和结束位置，第二个分区别记录下一个逻辑 分区的起始位置，第三第四个分区表未使用。  

#### **GPT（GUID Partition Table）**

全局唯一标识分区表（GUID Partition Table，缩写：GPT）是一个实体硬盘的分区表的结构布局的标准。

##### **结构**
![20200909110312](https://raw.githubusercontent.com/protoleoxu/picGo/master/images/20200909110312.png)

### **格式化**

**低级格式化**：早先为对磁盘划分柱面、磁道、扇区的操作，使硬盘具备存储能力。  
**高级格式化**：又称逻辑格式化，它是指根据用户选定的文件系统（如FAT12、FAT16、FAT32、exFAT、NTFS、EXT2、EXT3等），在磁盘的特定区域写入特定数据，以达到初始化磁盘或磁盘分区、清除原磁盘或磁盘分区中所有文件的一个操作。  

## **文件系统**

磁盘读写单位为扇区，扇区大小可能为512B、1024B。文件系统读写单位为数据块，数据块大小可能为1024B、2048B、4096B。

磁盘维护磁盘逻辑块地址（LBA），文件系统维护逻辑数据块地址。

当磁盘IO发生时，文件系统IO管理器会将需要读写的数据库地址转换为LBA，发送给磁盘，磁盘控制器收到LBA会将其翻译为扇区地址，从扇区读取数据之后再将数据打包写入内存。

磁盘上的分区对应一个文件系统，LVM及RAID可以将多个分区格式化为一个文件系统，或者将一个分区格式化多个文件系统。

### **基于inode的文件系统**

![20200916112331](https://raw.githubusercontent.com/protoleoxu/picGo/master/images/20200916112331.png)

分区格式化文件系统后，分区头部为Boot Block，剩余部分会再次按照分区大小分为多个块组（Block Group），块组按照为元数据区和数据区。  
其中元数据区包含Super Block、Group Descriptor Table、Reserved Group Descriptor Table、Inode Bitmap、Block Bitmap、Inode Table，其中前三个不一定在所有块组中出现，一般在1、3、5、7等幂次方块组出现。

#### **结构**

**Super Block**：描述整个文件系统的信息，分区概览。一个文件系统只能有一个Super Block，其他块组的Super Block为备份。记录文件系统Block、Inode总量，挂载状态，已使用和未使用的Inode、Block数量，Inode、Block大小等等。

**GDT**：包含所有块组信息的列表，记录各个块组起始与结束Block地址。

**Reversed GDT**：保留GDT，当GDT不足时用于补充。

**Block Bitmap**：使用位图表示该块组内部Block的使用情况，使用和未使用。

**Inode Bitmap**：使用位图表示该块组内部Inode使用情况，使用和未使用。

**Inode Table**：保存所有文件的元数据信息，元数据包含文件大小、文件类型、文件属组属主、文件权限、atime、mtime、ctime、链接数、文件特性、文件数据指针等等。

**Data Block**：文件数据保存的区域。

#### **Data Block存储结构**

不同文件类型在Data Block中存储结构不同。  
linux几种文件类型及其Data Block存储结构：

- 普通文件：-，普通文件在Data Block中存储文件内容。
- 目录文件：d，目录文件Data Block中存储目录内文件的文件名、文件类型的数字编码，文件名长度、其Inode以及本目录和父目录的硬链接信息等。
- 软连接：l，软连接文件不一定有Data Block，其实质类似windows平台快捷方式，存储的是某文件的文件名。如果指向的文件名长度较小，则直接存储在软连接文件的Inode信息中，如果文件名长，则需要存储在Data Block中。
- 块设备文件：b，以下几种文件都不存在Data Block，只需要Inode信息就可以保存所有信息。设备文件较为特殊，Inode中会保存其主设备号和次设备号。主设备号代表使用的某种设备类型，此设备文件代表同种设别类型的不同编号。
- 字符设备文件：c
- 命名管道：p
- socket文件（套接字）：s

#### **文件操作**

- 写入：  
  - 在GDT中查找对应块组的inode map和block map，分配inode
  - 在inode table中补充对应inode信息  
  - 在文件当前目录的Data Block中添加该文件的信息  
  - 向Data Block写入文件内容，每次写入一个块，直至写入完成  
  - 更新inode table中对应inode的block指针

- 读取：  
  - 读取GDT找到inode table  
  - 找到"/"inode，一般为2  
  - 读取"/"Data Block内容  
  - 找到下一级目录inode  
  - 读取下一级目录Data Block内容  
  - 找到文件inode  
  - 读取文件Data Block  

- 删除（文件）：  
  - 找到文件inode  
  - 在对应inode table中将该inode删除  
  - 将inode map中该文件对应inode标记未未使用  
  - 在文件所属目录Data Block中将该文件的inode改为0  
  - 将block map中该文件占用的block标记为未使用

- 删除（目录）：
  - 找到目录和目录下所有文件的inode、block
  - 在inode map中标记这些inode为未使用
  - 在block map中标记这些block为未使用
  - 在该目录上级目录Data Block中将该目录inode改为0

- 重命名（同目录）：
  - （无命名冲突）修改上级目录Data Block中保存的该文件名
  - （有命名冲突）覆盖上级目录Data Block中同名文件的信息

- 重命名（不同目录）：
  - 移动文件

- 移动（相同文件系统）：
  - （无命名冲突）在目标目录Data Block中添加文件inode信息
  - （有命名冲突）覆盖目标目录Data Block中同名文件的信息

- 移动（不同文件系统）：
  - 写入后删除

#### **注意点**

- 存在孤儿Inode：当Inode Table中存在某Inode，而无法在文件系统索引到它，则称为孤儿Inode。
- 硬链接：硬链接本质与建立硬链接的文件没有任何区别，Inode信息相同，Data Block相同，每次为文件建立硬链接，Inode信息中的硬链接数会加一。当硬链接数为零时，代表文件被删除。
- 硬链接的特殊性：
  - 不能为目录建立硬链接。目录文件本身会存储一个自身硬链接"."，文件系统在
  - 不能跨文件系统建立硬链接
- 只有根目录才能自引用，即存储的"."、".."inode相同
- 挂载前后，目录的保存的信息不同，是因为挂在前后目录inode不同
- 日志功能，ext3之后增加了日志功能，在格式化文件系统时除了元数据区和数据区，还多了日志区。文件系统在进行存储时，会现在日志区写入目标文件的信息及操作类型，在写入数据区完成后，再将日志区中该操作标记为完成。
- 块设备、字符设备区别：简单地说就是是否能支持随机访问。

## **启动引导**

## **LVM**

## **RAID**

